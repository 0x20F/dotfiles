#!/bin/sh
set -euo pipefail


# Dimensions
width=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]*x[0-9][0-9]*[^ ]*' | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/' |cut -d "x" -f 1 |head -n1)
height=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]*x[0-9][0-9]*[^ ]*' | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/' |cut -d "x" -f 2 |head -n1)
half_width=$(( width / 2 ))
half_height=$(( height / 2 ))

indicator_offset=70
ring_width=3
user_radius=150

user_w=$(( user_radius * 2 ))
user_h=$(( user_radius * 2  ))
user_x=$(( half_width - user_radius ))
user_y=$(( half_height - user_h + (ring_width * 2 + 1) ))


# Helpers
cache=$HOME/.cache/lockscreen
pictures=$HOME/.pictures
wallpapers=$( ix -f paths.wallpapers )
font="JetBrainsMono Nerd Font"

# Background image
background="$wallpapers/background.jpg"
background_hash=$( md5sum $background | awk '{ print $1 }' )
background_output="$background_hash-background.png"
# User image
user="$pictures/profile.png"
user_hash="$(md5sum $user | awk '{ print $1 }')"
user_output="$user_hash-user-profile.png"
# Final image
lockscreen_background_hash=$( echo "$user_hash-$background_hash" | md5sum | awk '{ print $1 }' )
lockscreen_background="$lockscreen_background_hash-lockscreen.png"




crop_user() {
	dimensions="$((user_w))x$((user_h))"

	if [[ -f "$user_output" ]]; then
		return
	fi

	convert $user -resize $dimensions -gravity center \( \
		-size $dimensions xc:Black 		\
		-fill White 			\
			-draw "circle $user_radius $user_radius $user_radius 1" 	\
		-alpha Copy			\
		\) -compose CopyOpacity -composite -trim $cache/$user_output
}



blur_background() {
	if [[ -f "$cache/$background_output" ]]; then
		return
	fi

	convert $background \
		-gravity center \
		-filter Gaussian	\
		-blur 0x27		\
		-crop 16:10		\
		-resize "$((width))x$((height))" \
		"$cache/$background_output"
}



combine_images() {
	if [[ -f "$cache/$lockscreen_background" ]]; then
		return
	fi

	composite -geometry "+${user_x}+${user_y}" $cache/$user_output $cache/$background_output $cache/$lockscreen_background
}



generate_background() {
	if [[ ! -d $HOME/.cache/lockscreen ]]; then
		mkdir $HOME/.cache/lockscreen
	fi

	crop_user
	blur_background
	combine_images
}



lock() {
	generate_background

	i3lock-color -n -c 24283100 -e 			\
		-i "$cache/$lockscreen_background"	\
		--centered							\
		--datestr="" 						\
		--indicator							\
		--force-clock						\
		--pass-media-keys					\
		--pass-power-keys					\
		--pass-volume-keys					\
		--insidevercolor=2e3440a8			\
		--insidewrongcolor=2e3440a8			\
		--insidecolor=2e344000				\
		--ringwrongcolor=bf616a				\
		--ringcolor=81a1c1					\
		--ringvercolor=88c0d0				\
		--line-uses-inside					\
		--keyhlcolor=b48ead					\
		--bshlcolor=bf616a					\
		--separatorcolor=81a1c1				\
		--verifcolor=88c0d0					\
		--wrongcolor=bf616a					\
		--indpos="w/2:h/2-$indicator_offset"\
		--timecolor=e5e9f0					\
		--timepos="w/2:h/2+60"				\
		--timestr="%I:%M %p"				\
		--datecolor=e5e9f0					\
		--time-font="$font"					\
		--date-font="$font"					\
		--verif-font="$font"				\
		--wrong-font="$font"				\
		--greeter-font="$font:style=Bold"	\
		--greetertext="$USER"				\
		--greetercolor=8fbcbb				\
		--greeterpos="w/2:h/2+40"			\
		--radius="$(( $user_radius / 2 ))"	\
		--ring-width="$ring_width"			\
		--greetersize=18					\
		--timesize=16						\
		--verifsize=10						\
		--wrongsize=10						\
		--modsize=9							\
		--modifpos="w/2:h/2-15"
}

lock
